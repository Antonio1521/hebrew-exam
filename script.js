const I18N = {
    ru: {
        menu_theory: "–ë–∞–∑–∞ –ó–Ω–∞–Ω–∏–π", btn_connectors: "üîó –¢–∞–±–ª–∏—Ü–∞ –°–≤—è–∑–æ–∫", btn_vocab: "üìö –°–ª–æ–≤–∞—Ä—å", btn_graphs: "üìä –ì—Ä–∞—Ñ–∏–∫–∏", btn_writing: "üìù –®–∞–±–ª–æ–Ω—ã –ü–∏—Å—å–º–∞",
        menu_drills: "–¢—Ä–µ–Ω–∞–∂–µ—Ä—ã", btn_logic: "üß† –õ–æ–≥–∏–∫–∞ (–ß–∞—Å—Ç—å B)", btn_rewrite: "‚úçÔ∏è –®–∏—Ö—Ç—É–≤", btn_combine: "üß© –•–∏–±—É—Ä", btn_drill_graphs: "üìà –•–∞–º–ª–∞–ª–∞",
        menu_exam: "–≠–∫–∑–∞–º–µ–Ω", btn_essay: "üíª –°–∏–º—É–ª—è—Ç–æ—Ä –≠—Å—Å–µ",
        title_connectors: "–¢–∞–±–ª–∏—Ü–∞ –õ–æ–≥–∏—á–µ—Å–∫–∏—Ö –°–≤—è–∑–æ–∫", title_vocab: "–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –°–ª–æ–≤–∞—Ä—å", title_graphs: "–°–ª–æ–≤–∞—Ä—å –¥–ª—è –ì—Ä–∞—Ñ–∏–∫–æ–≤", title_writing: "–®–∞–±–ª–æ–Ω—ã –ü–∏—Å—å–º–∞",
        subtitle_structure: "◊û◊ë◊†◊î ◊§◊°◊ß◊™ ◊¢◊û◊ì◊î (–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ú–Ω–µ–Ω–∏—è)",
        title_logic_drill: "–¢—Ä–µ–Ω–∞–∂–µ—Ä: –õ–æ–≥–∏–∫–∞", title_rewrite_drill: "–¢—Ä–µ–Ω–∞–∂–µ—Ä: –®–∏—Ö—Ç—É–≤", title_combine_drill: "–¢—Ä–µ–Ω–∞–∂–µ—Ä: –•–∏–±—É—Ä", title_graphs_drill: "–¢—Ä–µ–Ω–∞–∂–µ—Ä: –ì—Ä–∞—Ñ–∏–∫–∏",
        title_essay_sim: "–°–∏–º—É–ª—è—Ç–æ—Ä –≠—Å—Å–µ", opt_select_topic: "üîΩ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É —ç–∫–∑–∞–º–µ–Ω–∞...", msg_select_prompt: "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–∞–¥–∞–Ω–∏–µ.",
        btn_new_questions: "üîÑ –ù–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã", btn_check: "üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å", btn_reset: "üóëÔ∏è –°–±—Ä–æ—Å",
        label_source_text: "üìÑ –¢–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è",
        table_conn: "–°–≤—è–∑–∫–∞", table_gram: "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", table_ex: "–ü—Ä–∏–º–µ—Ä", table_bad: "–ù–µ –ø–∏—Å–∞—Ç—å", table_good: "–ü–∏—Å–∞—Ç—å", table_cat: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", table_words: "–°–ª–æ–≤–∞"
    },
    en: {
        menu_theory: "Knowledge Base", btn_connectors: "üîó Connectors Table", btn_vocab: "üìö Vocabulary", btn_graphs: "üìä Graphs Info", btn_writing: "üìù Writing Templates",
        menu_drills: "Drills", btn_logic: "üß† Logic (Part B)", btn_rewrite: "‚úçÔ∏è Rewrite", btn_combine: "üß© Combine", btn_drill_graphs: "üìà Graphs",
        menu_exam: "Exam Mode", btn_essay: "üíª Essay Simulator",
        title_connectors: "Connectors Table", title_vocab: "Academic Vocabulary", title_graphs: "Graphs Vocabulary", title_writing: "Writing Templates",
        subtitle_structure: "Opinion Paragraph Structure",
        title_logic_drill: "Drill: Logic", title_rewrite_drill: "Drill: Rewrite", title_combine_drill: "Drill: Combine", title_graphs_drill: "Drill: Graphs",
        title_essay_sim: "Essay Simulator", opt_select_topic: "üîΩ Select exam topic...", msg_select_prompt: "Select a topic to see the prompt.",
        btn_new_questions: "üîÑ New Questions", btn_check: "üîç Check", btn_reset: "üóëÔ∏è Reset",
        label_source_text: "üìÑ Source Text",
        table_conn: "Connector", table_gram: "Grammar", table_ex: "Example", table_bad: "Don't use", table_good: "Use", table_cat: "Category", table_words: "Words"
    },
    he: {
        menu_theory: "◊û◊ê◊í◊® ◊ô◊ì◊¢", btn_connectors: "üîó ◊û◊ô◊ú◊ï◊™ ◊ß◊ô◊©◊ï◊®", btn_vocab: "üìö ◊ê◊ï◊¶◊® ◊û◊ô◊ú◊ô◊ù", btn_graphs: "üìä ◊í◊®◊§◊ô◊ù", btn_writing: "üìù ◊™◊ë◊†◊ô◊ï◊™ ◊õ◊™◊ô◊ë◊î",
        menu_drills: "◊™◊®◊í◊ï◊ú", btn_logic: "üß† ◊ú◊ï◊í◊ô◊ß◊î", btn_rewrite: "‚úçÔ∏è ◊©◊ó◊®◊ï◊ë", btn_combine: "üß© ◊ó◊ô◊ë◊ï◊® ◊û◊©◊§◊ò◊ô◊ù", btn_drill_graphs: "üìà ◊î◊û◊ú◊ú◊î",
        menu_exam: "◊ë◊ó◊ô◊†◊î", btn_essay: "üíª ◊°◊ô◊û◊ï◊ú◊ò◊ï◊® ◊õ◊™◊ô◊ë◊î",
        title_connectors: "◊ò◊ë◊ú◊™ ◊û◊ô◊ú◊ï◊™ ◊ß◊ô◊©◊ï◊®", title_vocab: "◊ê◊ï◊¶◊® ◊û◊ô◊ú◊ô◊ù ◊ê◊ß◊ì◊û◊ô", title_graphs: "◊û◊ô◊ú◊ï◊ü ◊ú◊™◊ô◊ê◊ï◊® ◊í◊®◊§◊ô◊ù", title_writing: "◊™◊ë◊†◊ô◊ï◊™ ◊õ◊™◊ô◊ë◊î",
        subtitle_structure: "◊û◊ë◊†◊î ◊§◊°◊ß◊™ ◊¢◊û◊ì◊î",
        title_logic_drill: "◊™◊®◊í◊ï◊ú: ◊ú◊ï◊í◊ô◊ß◊î", title_rewrite_drill: "◊™◊®◊í◊ï◊ú: ◊©◊ó◊®◊ï◊ë", title_combine_drill: "◊™◊®◊í◊ï◊ú: ◊ó◊ô◊ë◊ï◊®", title_graphs_drill: "◊™◊®◊í◊ï◊ú: ◊î◊û◊ú◊ú◊î",
        title_essay_sim: "◊°◊ô◊û◊ï◊ú◊ò◊ï◊® ◊õ◊™◊ô◊ë◊î", opt_select_topic: "üîΩ ◊ë◊ó◊® ◊†◊ï◊©◊ê...", msg_select_prompt: "◊ë◊ó◊® ◊†◊ï◊©◊ê ◊õ◊ì◊ô ◊ú◊®◊ê◊ï◊™ ◊ê◊™ ◊î◊û◊ò◊ú◊î.",
        btn_new_questions: "üîÑ ◊©◊ê◊ú◊ï◊™ ◊ó◊ì◊©◊ï◊™", btn_check: "üîç ◊ë◊ì◊ï◊ß", btn_reset: "üóëÔ∏è ◊ê◊ô◊§◊ï◊°",
        label_source_text: "üìÑ ◊ò◊ß◊°◊ò ◊ú◊ß◊®◊ô◊ê◊î",
        table_conn: "◊û◊ô◊ú◊î", table_gram: "◊ì◊ß◊ì◊ï◊ß", table_ex: "◊ì◊ï◊í◊û◊î", table_bad: "◊ú◊ê ◊û◊ï◊û◊ú◊•", table_good: "◊û◊ï◊û◊ú◊•", table_cat: "◊ß◊ò◊í◊ï◊®◊ô◊î", table_words: "◊û◊ô◊ú◊ô◊ù"
    }
};

const app = {
    currentLang: 'ru',

    init: function() {
        this.renderTheory();
        this.renderDrill('logic');
        this.populateEssayTopics();
        this.changeLanguage();
    },

    changeLanguage: function() {
        const lang = document.getElementById('lang-select').value;
        this.currentLang = lang;
        const texts = I18N[lang];

        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (texts[key]) el.innerHTML = texts[key];
        });

        if (lang === 'he') {
            document.documentElement.setAttribute('dir', 'rtl');
            document.querySelector('.sidebar').style.borderLeft = 'none';
            document.querySelector('.sidebar').style.borderRight = '5px solid var(--accent)';
        } else {
            document.documentElement.setAttribute('dir', 'ltr');
            document.querySelector('.sidebar').style.borderLeft = '5px solid var(--accent)';
            document.querySelector('.sidebar').style.borderRight = 'none';
        }

        this.renderTheory();
        document.getElementById('essay-area').placeholder = lang === 'he' ? "◊î◊™◊ó◊ú ◊ú◊õ◊™◊ï◊ë ◊õ◊ê◊ü..." : (lang === 'en' ? "Start writing here..." : "–ù–∞—á–∏–Ω–∞–π—Ç–µ –ø–∏—Å–∞—Ç—å –∑–¥–µ—Å—å...");
    },

    show: function(id, btn) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        if(id.startsWith('drill-') && document.getElementById('container-'+id.split('-')[1]).innerHTML === "") {
            this.renderDrill(id.split('-')[1]);
        }
    },

    renderTheory: function() {
        const t = I18N[this.currentLang];
        const createTable = (data, headers) => {
            let html = `<table><thead><tr><th>${headers[0]}</th><th>${headers[1]}</th><th>${headers[2] || ''}</th></tr></thead><tbody>`;
            data.forEach(row => {
                html += `<tr><td><b>${row.word || row.bad || row.cat}</b></td><td>${row.rule || row.good || row.items}</td><td>${row.ex || ''}</td></tr>`;
            });
            html += '</tbody></table>';
            return html;
        };

        document.getElementById('table-connectors-container').innerHTML = DATA.theory_connectors.map(g => `<h3>${g.group}</h3>${createTable(g.examples, [t.table_conn, t.table_gram, t.table_ex])}`).join('');
        document.getElementById('table-vocab-container').innerHTML = createTable(DATA.theory_vocab, [t.table_bad, t.table_good, '']);
        document.getElementById('table-graphs-container').innerHTML = createTable(DATA.theory_graphs, [t.table_cat, t.table_words, '']);
    },

    renderDrill: function(type) {
        const container = document.getElementById('container-' + type);
        container.innerHTML = '';
        const items = [...DATA['drill_' + type]].sort(() => 0.5 - Math.random()).slice(0, 20);

        items.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            let title = `–í–æ–ø—Ä–æ—Å ${index + 1}`;
            if(item.task) title = item.task; 
            let content = item.q;
            if (!content) {
                if (item.original) {
                    content = `"${item.original}"`;
                } else {
                    content = `1. ${item.s1}<br>2. ${item.s2}`;
                }
            }
            
            let html = `<div class="q-text"><span class="task-label">${title}</span><br>${content}</div>`;
            item.options.forEach((opt, idx) => {
                const safeExplain = item.explain.replace(/'/g, "\\'");
                html += `<button class="opt-btn" onclick="app.checkAnswer(this, ${idx === item.correct}, '${safeExplain}')">${opt}</button>`;
            });
            html += `<div class="feedback"></div>`;
            card.innerHTML = html;
            container.appendChild(card);
        });
    },

    checkAnswer: function(btn, isCorrect, explain) {
        const parent = btn.parentElement;
        const feedback = parent.querySelector('.feedback');
        parent.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
        const t = this.currentLang === 'he' ? {y: '◊†◊õ◊ï◊ü', n: '◊©◊í◊ô◊ê◊î'} : (this.currentLang === 'en' ? {y: 'Correct', n: 'Wrong'} : {y: '–í–µ—Ä–Ω–æ', n: '–û—à–∏–±–∫–∞'});

        if (isCorrect) {
            btn.classList.add('correct');
            feedback.innerHTML = `‚úÖ <b>${t.y}!</b> ${explain}`;
            feedback.style.background = "#d4edda"; feedback.style.color = "#155724";
        } else {
            btn.classList.add('wrong');
            feedback.innerHTML = `‚ùå <b>${t.n}.</b> ${explain}`;
            feedback.style.background = "#f8d7da"; feedback.style.color = "#721c24";
        }
        feedback.style.display = 'block';
    },

    toggleCheatSheet: function() {
        const sheet = document.getElementById('connectors-cheat-sheet');
        if (sheet.style.display === "none") {
            sheet.style.display = "block";
        } else {
            sheet.style.display = "none";
        }
    },

    populateEssayTopics: function() {
        const select = document.getElementById('essay-topic');
        select.innerHTML = `<option value="" data-i18n="opt_select_topic">${I18N[this.currentLang].opt_select_topic}</option>`;
        for (const [key, value] of Object.entries(DATA.essay_prompts)) {
            const title = value.split('<br>')[0].replace('<b>', '').replace('</b>', '').replace('<h4>', '').replace('</h4>', '');
            const option = document.createElement('option');
            option.value = key;
            option.text = title;
            select.appendChild(option);
        }
    },

    setEssayTopic: function() {
        const val = document.getElementById('essay-topic').value;
        const promptDiv = document.getElementById('essay-prompt');
        const textDiv = document.getElementById('source-text-container');
        
        if (val && DATA.essay_prompts[val]) {
            promptDiv.innerHTML = DATA.essay_prompts[val];
            if (DATA.essay_texts && DATA.essay_texts[val]) {
                textDiv.innerHTML = DATA.essay_texts[val];
            } else {
                textDiv.innerHTML = "<p style='text-align:center; margin-top:50px;'>–¢–µ–∫—Å—Ç –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.</p>";
            }
        } else {
            promptDiv.innerHTML = I18N[this.currentLang].msg_select_prompt;
            textDiv.innerHTML = "<p style='color:#7f8c8d; text-align:center; margin-top:50px;'>" + (this.currentLang === 'he' ? "◊ë◊ó◊® ◊†◊ï◊©◊ê ◊õ◊ì◊ô ◊ú◊®◊ê◊ï◊™ ◊ê◊™ ◊î◊ò◊ß◊°◊ò." : "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç–µ–∫—Å—Ç.") + "</p>";
        }
    },

    analyzeEssay: function() {
        const text = document.getElementById('essay-area').value.trim();
        const feedbackEl = document.getElementById('essay-feedback');
        
        if (text.length === 0) return;

        // Statistics
        const words = text.split(/\s+/).filter(w => w.length > 0);
        const sentences = text.split(/[.?!]+/).filter(s => s.trim().length > 0);
        const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
        
        let score = 0;
        let tips = [];
        let goodPoints = [];

        // 1. Length
        if (words.length < 30) {
            score += 10; tips.push("üî¥ –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π.");
        } else if (words.length < 80) {
            score += 40; tips.push("üü† –•–æ—Ä–æ—à–µ–µ –Ω–∞—á–∞–ª–æ, –Ω–æ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π.");
        } else {
            score += 100; goodPoints.push("‚úÖ –û—Ç–ª–∏—á–Ω—ã–π –æ–±—ä–µ–º.");
        }
        const lenScore = Math.min(score, 20);

        // 2. Vocabulary Check (Connectors)
        let foundConn = 0;
        let usedConn = [];
        DATA.theory_connectors.forEach(g => g.examples.forEach(ex => {
            const keyword = ex.word.split(' / ')[0];
            if(text.includes(keyword)) { foundConn++; usedConn.push(keyword); }
        }));
        // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        usedConn = [...new Set(usedConn)];

        let vocabScore = 0;
        if(foundConn < 2) { vocabScore=5; tips.push("üî¥ –ú–∞–ª–æ —Å–≤—è–∑–æ–∫ (◊û◊ô◊ú◊ï◊™ ◊ß◊ô◊©◊ï◊®)."); }
        else { vocabScore=30; goodPoints.push(`‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Å–≤—è–∑–∫–∏: ${usedConn.slice(0,3).join(', ')}...`); }

        // 3. Structure
        let structScore = 0;
        if(text.includes("◊ú◊ì◊¢◊™◊ô") || text.includes("◊ê◊†◊ô ◊°◊ë◊ï◊®")) { structScore+=15; goodPoints.push("‚úÖ –ï—Å—Ç—å –º–Ω–µ–Ω–∏–µ."); }
        else { tips.push("üî¥ –ù–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏—è –º–Ω–µ–Ω–∏—è (◊ú◊ì◊¢◊™◊ô...)."); }

        if(text.includes("◊®◊ê◊©◊ô◊™") || text.includes("◊°◊ô◊ë◊î") || text.includes("◊ë◊†◊ï◊°◊£")) { structScore+=15; goodPoints.push("‚úÖ –ï—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã."); }
        else { tips.push("üî¥ –ù–µ—Ç –º–∞—Ä–∫–µ—Ä–æ–≤ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (◊®◊ê◊©◊ô◊™/◊°◊ô◊ë◊î...)."); }

        if(text.includes("◊ú◊°◊ô◊õ◊ï◊ù") || text.includes("◊ú◊ê◊ï◊® ◊î◊ê◊û◊ï◊®")) { structScore+=20; goodPoints.push("‚úÖ –ï—Å—Ç—å –≤—ã–≤–æ–¥."); }
        else { tips.push("üî¥ –ù–µ—Ç –≤—ã–≤–æ–¥–∞ (◊ú◊°◊ô◊õ◊ï◊ù...)."); }

        // Total
        const total = Math.min(100, lenScore + vocabScore + structScore);
        const color = total > 80 ? "green" : (total > 50 ? "orange" : "red");

        let html = `
            <div class="score-box ${color}"><h3>–û—Ü–µ–Ω–∫–∞: ${total}/100</h3>
            <span style="font-size:0.8em">–°–ª–æ–≤: ${words.length} | –ê–±–∑–∞—Ü–µ–≤: ${paragraphs.length}</span></div>
            <div class="analysis-grid">
                <div class="col"><h4>üëç –•–æ—Ä–æ—à–æ:</h4><ul>${goodPoints.length ? goodPoints.map(i=>`<li>${i}</li>`).join('') : '<li>–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ...</li>'}</ul></div>
                <div class="col"><h4>üí° –°–æ–≤–µ—Ç—ã:</h4><ul>${tips.length ? tips.map(i=>`<li>${i}</li>`).join('') : '<li>–í—Å—ë –æ—Ç–ª–∏—á–Ω–æ!</li>'}</ul></div>
            </div>
        `;
        feedbackEl.innerHTML = html;
    }
};

app.init();
